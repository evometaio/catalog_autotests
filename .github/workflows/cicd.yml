name: Tests CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ'
        required: true
        default: 'prod'
        type: choice
        options: [prod, dev]
      run_type:
        description: 'Ð¢Ð¸Ð¿ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²'
        required: false
        default: 'regression'
        type: choice
        options: [smoke, regression, full]

env:
  ALLURE_REPORT_DIR: "allure-report"
  ALLURE_RESULTS_DIR: "allure-results"
  PROD_BASE_URL: "https://virtualtours.qbd.ae/map"
  DEV_BASE_URL: "https://qube-dev-next.evometa.io/map"
  DEV_AGENT_BASE_URL: "https://qube-dev-next.evometa.io/agent/map"
  DEV_CLIENT_BASE_URL: "https://qube-dev-next.evometa.io/client/map"
  AGENT_PROD_BASE_URL: "https://virtualtours.qbd.ae/agent/map"
  CLIENT_PROD_BASE_URL: "https://virtualtours.qbd.ae/client/map"

jobs:
  ubuntu-firefox:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install allure-pytest pytest-playwright
          python -m playwright install firefox
          python -m playwright install-deps

      - name: Create environment properties
        run: |
          mkdir -p ${{ env.ALLURE_RESULTS_DIR }}
          cat > ${{ env.ALLURE_RESULTS_DIR }}/environment.properties << EOF
          # Test Environment Configuration
          environment = ${{ github.event.inputs.environment || 'prod' }}
          url = ${{ github.event.inputs.environment == 'prod' && env.PROD_BASE_URL || env.DEV_BASE_URL }}
          browser = firefox
          EOF
        env:
          TEST_ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}

      - name: Run tests (Firefox/Linux)
        run: pytest --browser=firefox --alluredir=${{ env.ALLURE_RESULTS_DIR }}
        env:
          TEST_ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-ubuntu-firefox
          path: ${{ env.ALLURE_RESULTS_DIR }}

  windows-chromium:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install allure-pytest pytest-playwright
          python -m playwright install chromium
          python -m playwright install-deps

      - name: Create environment properties
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ${{ env.ALLURE_RESULTS_DIR }}
          @"
          # Test Environment Configuration
          environment = ${{ github.event.inputs.environment || 'prod' }}
          url = ${{ github.event.inputs.environment == 'prod' && env.PROD_BASE_URL || env.DEV_BASE_URL }}
          browser = chromium
          "@ | Out-File -FilePath "${{ env.ALLURE_RESULTS_DIR }}/environment.properties" -Encoding UTF8
        env:
          TEST_ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}

      - name: Run tests (Chromium/Windows)
        shell: pwsh
        run: pytest --browser=chromium --alluredir=${{ env.ALLURE_RESULTS_DIR }}
        env:
          TEST_ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-windows-chromium
          path: ${{ env.ALLURE_RESULTS_DIR }}

  macos-webkit:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install allure-pytest pytest-playwright
          python -m playwright install webkit
          python -m playwright install-deps
          brew install allure

      - name: Create environment properties
        run: |
          mkdir -p ${{ env.ALLURE_RESULTS_DIR }}
          cat > ${{ env.ALLURE_RESULTS_DIR }}/environment.properties << EOF
          # Test Environment Configuration
          environment = ${{ github.event.inputs.environment || 'prod' }}
          url = ${{ github.event.inputs.environment == 'prod' && env.PROD_BASE_URL || env.DEV_BASE_URL }}
          browser = webkit
          EOF
        env:
          TEST_ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}

      - name: Run tests (Webkit/macOS)
        run: pytest --browser=webkit --alluredir=${{ env.ALLURE_RESULTS_DIR }}
        env:
          TEST_ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-macos-webkit
          path: ${{ env.ALLURE_RESULTS_DIR }}

  deploy-allure:
    runs-on: ubuntu-latest
    needs: [ubuntu-firefox, windows-chromium, macos-webkit]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download results
        uses: actions/download-artifact@v4
        with:
          path: allure-results

      - name: Install Allure
        run: |
          curl -Ls https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz -o allure.tgz
          sudo tar -zxvf allure.tgz -C /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure

      - name: Download previous history
        run: |
          mkdir -p old-history
          echo "ðŸ” ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ history.zip..."
          
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ history.zip Ð¸Ð· GitHub Pages
          curl -s -L -f "https://${{ github.repository_owner }}.github.io/${{ github.repository }}/allure-report/history.zip" -o history.zip || {
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ history.zip, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹"
            rm -f history.zip
          }

          if [ -f history.zip ] && [ -s history.zip ]; then
            echo "âœ… History.zip Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ..."
            if file history.zip | grep -q "Zip archive"; then
              echo "ðŸ“¦ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ history.zip..."
              unzip -q history.zip -d old-history
              echo "âœ… History ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
            else
              echo "âŒ Ð¤Ð°Ð¹Ð» Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ zip Ð°Ñ€Ñ…Ð¸Ð²Ð¾Ð¼, ÑƒÐ´Ð°Ð»ÑÐµÐ¼"
              rm -f history.zip
            fi
          else
            echo "â„¹ï¸ History Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹"
          fi

      - name: Generate Allure report with history
        run: |
          echo "ðŸ”§ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°..."
          mkdir -p combined-results
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¾Ð²
          find allure-results -type f -exec cp {} combined-results/ \;
          echo "âœ… Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¾Ð² ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"

          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ history ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
          if [ -d old-history/history ]; then
            echo "ðŸ“š ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ history..."
            cp -r old-history/history combined-results/
            echo "âœ… History Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½"
          else
            echo "â„¹ï¸ History Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹"
          fi

          # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
          echo "ðŸ“Š Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Allure Ð¾Ñ‚Ñ‡ÐµÑ‚..."
          allure generate combined-results --clean -o ${{ env.ALLURE_REPORT_DIR }}
          echo "âœ… ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½"

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ history.zip Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          cd ${{ env.ALLURE_REPORT_DIR }}
          if [ -d history ]; then
            echo "ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ history.zip..."
            zip -r ../../history.zip history/
            echo "âœ… History.zip ÑÐ¾Ð·Ð´Ð°Ð½"
          else
            echo "âš ï¸ ÐŸÐ°Ð¿ÐºÐ° history Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, history.zip Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½"
          fi
          cd ../..

      - name: Deploy Allure to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          destination_dir: allure-report

      - name: Upload history for next run
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-history
          path: history.zip
          retention-days: 30
        continue-on-error: true

  notify:
    runs-on: ubuntu-latest
    needs: [ubuntu-firefox, windows-chromium, macos-webkit, deploy-allure]
    if: always() && github.event_name == 'workflow_dispatch'
    steps:
      - name: Send Telegram summary
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ðŸš€ Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ Ñ‚ÐµÑÑ‚Ð°Ð¼

            ÐŸÑ€Ð¾ÐµÐºÑ‚: ${{ github.repository }}
            Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}
            ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ: ${{ github.event.inputs.environment || 'prod' }}
            Ð¢Ð¸Ð¿ Ð·Ð°Ð¿ÑƒÑÐºÐ°: ${{ github.event.inputs.run_type || 'regression' }}

            Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ${{ (needs.ubuntu-firefox.result == 'success' && needs.windows-chromium.result == 'success' && needs.macos-webkit.result == 'success') && 'âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸' || 'âŒ Ð•ÑÑ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸' }}

            ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚: <a href="https://${{ github.repository_owner }}.github.io/catalog_autotests/allure-report/">Allure</a>
            ðŸ”— Actions: <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">GH Actions</a>
          format: html
          disable_web_page_preview: true